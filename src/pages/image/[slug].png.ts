import type { APIContext } from 'astro';
import satori from 'satori'
import { html } from 'satori-html';
import { Resvg } from '@resvg/resvg-js';

const pages = await import.meta.glob('/src/content/colecciones/*.mdx', { eager: true });

export async function get({ params, request }: APIContext) {
  let q = `/src/content/colecciones/${params.slug}.mdx`;
  console.log(params)
  const { title, icono } = pages[q].frontmatter;
  const yeseva = await fetch('https://www.1001fonts.com/download/font/yeseva-one.regular.ttf').then(res => res.arrayBuffer())
  const markup = html`
  <div
		style="
    color: #111827;
    width: 1200px;
    height: 600px;
    display: flex;
    flex-direction: column;
    position: relative;
  "
	>
		<div
			style="
      width:100%;
      background-color: #282423;
      height: 400px;
      display: flex;
      justify-content: center;
      padding: 0px 50px;
      flex-direction: column;
      position: relative;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    "
		>
			<div
				style="
        font-size: 108px;
        font-weight: bold;
        color: #fff;
        text-align: center;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      "
			>
				${title}
			</div>
		</div>
		<div
			style="
      background-color: #282423;
      width: 100%;
      height: 200px;
      position: absolute; 
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0px 50px;
      border-top: 2px solid #282423;
			flex-direction: column;
    "
		>
			<div
				style="height: 100px; width: 100%; display: flex; justify-content: center; align-items: center;"
			>
				<svg
					style=" height: 100px; width: 100px"
					xmlns="http://www.w3.org/2000/svg"
					id="a"
					viewBox="0 0 133.61 146.16"
				>
					<path
						fill="#dea922"
						opacity="0.5"
						d="M33.2 73.25c.11 21.97 17.99 39.74 39.99 39.67 14.71-.07 27.53-8.06 34.39-19.99l-7.01-4.01s-.11-.07-.18-.07c-2.71-1.48-6.13-.99-8.2 1.27-.04 0-.07.07-.11.11-.35.39-.74.77-1.13 1.13-.32.35-.7.67-1.06.99-.14.18-.32.28-.53.46-.32.25-.6.49-.95.74-.04.08-.12.15-.21.18-.42.35-.84.63-1.3.92-.99.67-2.04 1.27-3.17 1.76-.39.18-.77.35-1.16.49-.18.11-.35.14-.56.21-.7.28-1.44.53-2.22.7-.32.11-.6.18-.95.25-1.21.31-2.45.5-3.7.56l-1.34.11h-.21c-.6 0-1.23 0-1.8-.04-.53-.04-1.06-.04-1.65-.18-.21 0-.42-.04-.63-.04-1.02-.18-2.01-.35-2.96-.63-.84-.25-1.69-.49-2.53-.81a25.478 25.478 0 0 1-14.89-14.71c-.25-.49-.39-1.02-.56-1.55-.18-.49-.35-1.06-.46-1.58-.18-.74-.32-1.51-.46-2.29-.07-.6-.18-1.16-.21-1.76-.04-.42-.07-.84-.07-1.27-.04-.11 0-.21 0-.32 0-.88 0-1.72.11-2.57.04-.46.07-.92.18-1.37.39-3.03 1.34-5.91 2.71-8.52.21-.39.42-.81.67-1.16.84-1.48 1.9-2.85 2.99-4.05.74-.84 1.51-1.58 2.36-2.29.42-.35.92-.74 1.37-1.06 2.18-1.62 4.58-2.85 7.15-3.73.99-.35 2.04-.63 3.13-.81 1.02-.21 2.11-.35 3.2-.42 1.57-.11 3.15-.09 4.72.07.7.07 1.41.21 2.15.35.18.04.35.04.53.11.63.18 1.3.32 1.9.49.28.07.53.18.81.25.7.25 1.41.53 2.08.84 1.51.66 2.95 1.47 4.29 2.43.14.11.28.21.42.28.6.46 1.16.92 1.76 1.41 0 .04.04.07.11.11.49.46.99.92 1.48 1.41.11.14.25.25.39.39 2.18 2.32 5.63 2.92 8.45 1.44l.18-.11 6.93-4.05c-6.9-11.9-19.78-19.82-34.5-19.78-22 .14-39.81 18.06-39.74 40.06Z"
					></path>
					<path
						fill="#dea922"
						opacity="0.5"
						d="M15.67 73.29c.11 31.68 25.87 57.27 57.55 57.17 21.19-.11 39.64-11.65 49.49-28.83l-15.17-8.69-7.01-4.01s-.11-.07-.18-.07c-2.71-1.48-6.13-.99-8.2 1.27-.04 0-.07.07-.11.11-.35.39-.74.77-1.13 1.13-.32.35-.7.67-1.06.99-.14.18-.32.28-.53.46-.32.25-.6.49-.95.74-.04.08-.12.15-.21.18-.42.35-.84.63-1.3.92-.99.67-2.04 1.27-3.17 1.76-.39.18-.77.35-1.16.49-.18.11-.35.14-.56.21-.7.28-1.44.53-2.22.7-.32.11-.6.18-.95.25-1.21.31-2.45.5-3.7.56l-1.34.11h-.21c-.6 0-1.23 0-1.8-.04-.53-.04-1.06-.04-1.65-.18-.21 0-.42-.04-.63-.04-1.02-.18-2.01-.35-2.96-.63-.84-.25-1.69-.49-2.53-.81a25.478 25.478 0 0 1-14.89-14.71c-.25-.49-.39-1.02-.56-1.55-.18-.49-.35-1.06-.46-1.58-.18-.74-.32-1.51-.46-2.29-.07-.6-.18-1.16-.21-1.76-.04-.42-.07-.84-.07-1.27-.04-.11 0-.21 0-.32 0-.88 0-1.72.11-2.57.04-.46.07-.92.18-1.37.39-3.03 1.34-5.91 2.71-8.52.21-.39.42-.81.67-1.16.84-1.48 1.9-2.85 2.99-4.05.74-.84 1.51-1.58 2.36-2.29.42-.35.92-.74 1.37-1.06 2.18-1.62 4.58-2.85 7.15-3.73.99-.35 2.04-.63 3.13-.81 1.02-.21 2.11-.35 3.2-.42 1.57-.11 3.15-.09 4.72.07.7.07 1.41.21 2.15.35.18.04.35.04.53.11.63.18 1.3.32 1.9.49.28.07.53.18.81.25.7.25 1.41.53 2.08.84 1.51.66 2.95 1.47 4.29 2.43.14.11.28.21.42.28.6.46 1.16.92 1.76 1.41 0 .04.04.07.11.11.49.46.99.92 1.48 1.41.11.14.25.25.39.39 2.18 2.32 5.63 2.92 8.45 1.44l.18-.11L107.4 53l15.14-8.84c-9.96-17.07-28.55-28.55-49.74-28.44-31.61.14-57.24 25.91-57.13 57.59Z"
					></path>
					<path
						fill="#dea922"
						opacity="0.5"
						d="M0 73.36c.14 40.34 32.95 72.94 73.32 72.8 1.58 0 3.2-.07 4.75-.18 1.55-.11 3.13-.25 4.65-.46 1.55-.21 3.06-.46 4.58-.74a73.643 73.643 0 0 0 21.23-7.78c.99-.53 1.97-1.13 2.89-1.72.35-.21.67-.42 1.02-.63.99-.6 1.94-1.23 2.85-1.9.84-.6 1.72-1.23 2.53-1.9l.95-.74c1.3-1.02 2.57-2.15 3.77-3.24 1.06-.99 2.08-1.97 3.1-3.03 1.3-1.3 2.5-2.71 3.7-4.15.56-.63 1.09-1.27 1.55-1.94.49-.6.99-1.23 1.48-1.9.04-.07.11-.14.14-.25 2.18-3.27 1.02-7.81-2.43-9.79l-7.29-4.19-15.17-8.69-7.01-4.01s-.11-.07-.18-.07c-2.71-1.48-6.13-.99-8.2 1.27-.04 0-.07.07-.11.11-.35.39-.74.77-1.13 1.13-.32.35-.7.67-1.06.99-.14.18-.32.28-.53.46-.32.25-.6.49-.95.74-.04.08-.12.15-.21.18-.42.35-.84.63-1.3.92-.99.67-2.04 1.27-3.17 1.76-.39.18-.77.35-1.16.49-.18.11-.35.14-.56.21-.7.28-1.44.53-2.22.7-.32.11-.6.18-.95.25-1.21.31-2.45.5-3.7.56l-1.34.11h-.21c-.6 0-1.23 0-1.8-.04-.53-.04-1.06-.04-1.65-.18-.21 0-.42-.04-.63-.04-1.02-.18-2.01-.35-2.96-.63-.84-.25-1.69-.49-2.53-.81a25.478 25.478 0 0 1-14.89-14.71c-.25-.49-.39-1.02-.56-1.55-.18-.49-.35-1.06-.46-1.58-.18-.74-.32-1.51-.46-2.29-.07-.6-.18-1.16-.21-1.76-.04-.42-.07-.84-.07-1.27-.04-.11 0-.21 0-.32 0-.88 0-1.72.11-2.57.04-.46.07-.92.18-1.37.39-3.03 1.34-5.91 2.71-8.52.21-.39.42-.81.67-1.16.84-1.48 1.9-2.85 2.99-4.05.74-.84 1.51-1.58 2.36-2.29.42-.35.92-.74 1.37-1.06 2.18-1.62 4.58-2.85 7.15-3.73.99-.35 2.04-.63 3.13-.81 1.02-.21 2.11-.35 3.2-.42 1.57-.11 3.15-.09 4.72.07.7.07 1.41.21 2.15.35.18.04.35.04.53.11.63.18 1.3.32 1.9.49.28.07.53.18.81.25.7.25 1.41.53 2.08.84 1.51.66 2.95 1.47 4.29 2.43.14.11.28.21.42.28.6.46 1.16.92 1.76 1.41 0 .04.04.07.11.11.49.46.99.92 1.48 1.41.11.14.25.25.39.39 2.18 2.32 5.63 2.92 8.45 1.44l.18-.11 6.93-4.05 15.14-8.84 7.22-4.19a6.957 6.957 0 0 0 2.58-9.5c-.11-.2-.23-.39-.36-.57v-.04a49.89 49.89 0 0 0-2.39-3.03c-.11-.18-.25-.32-.39-.49-.81-.99-1.62-1.94-2.5-2.85-.11-.14-.25-.32-.39-.42a51.11 51.11 0 0 0-2.43-2.46l-.88-.88c-.81-.7-1.58-1.44-2.39-2.15a.392.392 0 0 1-.18-.18c-.95-.74-1.87-1.51-2.78-2.22-.14-.11-.28-.21-.39-.28-.95-.7-1.9-1.41-2.85-2.08-.39-.25-.74-.53-1.09-.7-1.02-.67-2.04-1.34-3.1-1.94-1.2-.7-2.39-1.34-3.59-1.97 0-.04-.07-.07-.14-.07-1.06-.53-2.11-1.06-3.2-1.51-.28-.18-.6-.32-.92-.46-.84-.35-1.72-.7-2.57-1.06-.67-.28-1.41-.56-2.15-.81-.53-.21-1.09-.42-1.72-.6-.7-.28-1.48-.53-2.29-.74-.92-.28-1.87-.56-2.82-.74-.39-.11-.74-.18-1.09-.28-1.02-.28-2.01-.46-3.03-.67-.95-.18-1.94-.35-2.85-.42-.49-.11-.99-.18-1.44-.21a40.59 40.59 0 0 0-4.08-.42c-.21-.04-.39-.07-.56-.04C76.21.04 74.56 0 72.9 0 32.46.18-.14 32.98 0 73.36Z"
					></path>
				</svg>
			</div>
		</div>
	</div>
`;
  const svg = await satori(markup, {
    width: 1200,
    height: 600,
    fonts: [
      {
        name: 'Yeseva One',
        data: yeseva,
      }
    ],
  });

  const resvg = new Resvg(svg)
  const pngData = resvg.render()
  const pngBuffer = pngData.asPng()

  return {
    body: pngBuffer,
    encoding: 'binary',
    headers: {
      'Content-Type': 'image/png',
    }
  }
}

export async function getStaticPaths() {
  const paths = Object.keys(pages).map((path) => {
    const [, slug] = path.match(/\/colecciones\/(.*)\.mdx$/);
    return { params: { slug } };
  });
  return paths;
}